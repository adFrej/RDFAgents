<!DOCTYPE html>
<html>
  <head>
    <title>RDFAgents - simulation GUI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
      body {
        background: radial-gradient( circle at center in hsl shorter hue, #517970 15%, #374f54);
        width: 100vw;
        margin: 0;
        height: 100vh;
      }

      :root {
        --marker-dot-size: 6px;
      }

      #marker-root {
        width: 100%;
        height: 100%;
        position: absolute;
        z-index: -1;
      }

      .knowledge__container {
        display: flex;
        flex-wrap: wrap;
        gap: calc(1px * var(--scale));
        --width: calc((var(--marker-dot-size) * var(--marker-width) + 1px * (var(--marker-width) - 1)) * var(--scale));
        width: var(--width);

        padding: calc(2px * var(--border-scale));
        border: #2f3e46 calc(3px * var(--border-scale)) solid;
        border-radius: calc(4px * var(--border-scale));

        transition: border-color 0.5s;
        --scale: 1;
        --border-scale: calc((var(--scale) - 1) / 2 + 1)
      }

      .knowledge__container--in-circle {
        position: absolute;
        top: calc(50% - var(--width) / 2 - 3px);
        left: calc(50% - var(--width) / 2 - 3px);
        transform: rotate(calc(360deg * var(--angle))) translateY(-20vmin) rotate(calc(-360deg * var(--angle)));
      }

      .knowledge__container--master {
        border-color: #bfefc4;
      }


      .knowledge__container--global {
        --scale: 2;
      }

      .knowledge__marker {
        width: calc(var(--marker-dot-size) * var(--scale));
        height: calc(var(--marker-dot-size) * var(--scale));
        transition: background 0.5s;
      }
      .knowledge__marker--black {
        background: #374f54;
      }
      .knowledge__marker--green {
        background: #7ce495;
      }
      .knowledge__marker--red {
        background: #ff6f6f;
      }


      #panel-bottom {
        position: absolute;
        width: 100%;
        bottom: 0;
        display: flex;
        justify-content: space-around;
      }

      #global-markers {
        display: flex;
        gap: 1.8rem;
        width: fit-content;
        padding-bottom: 2rem;
        border-top-left-radius: 0.8rem;
        border-top-right-radius: 0.8rem;
      }

      .panel {
        background: #364a4e99;
        padding: 0.9rem;
      }

      .global-marker__container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .global-marker__label {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        font-weight: 450;
        font-style: normal;
        font-variation-settings: "slnt" 0;
        font-size: 1.5rem;
        color: #c9d2c6;
      }

      #panel-left {
        width: fit-content;
        height: fit-content;
        padding-left: 2rem;
        border-bottom-right-radius: 0.8rem;
        background: #28383a99;
      }

      .panel-left__button {
        font-family: "Inter", sans-serif;
        font-optical-sizing: auto;
        font-weight: 450;
        font-style: normal;
        font-variation-settings: "slnt" 0;
        font-size: 1.3rem;
        color: #c9d2c6;
        cursor: pointer;
      }
      
      .panel-left__button:hover {
        color: #bfefc4;
      }
      .panel-left__button:active {
        color: #ffefc4;
      }
    </style>
  </head>
  <body>
    <div id="marker-root"></div>
    <div id="panel-bottom">
      <div id="global-markers" class="panel"></div>
    </div>
    <div id="panel-left" class="panel">
      <div class="panel-left__button" onclick="buttonRestart()">Restart</div>
    </div>
    <script>
      // Endpoint utilities
      async function endpointGet(url) {
        let response = await fetch("/api/" + url);
        let data = await response.json();
        return data;
      }

      async function endpointPost(url, params={}) {
        let response = await fetch("/api/" + url + "?" + new URLSearchParams(params));
      }



      // State modificaiton
      function buttonRestart() {
        endpointPost("restart")
      }


      // Marker rendering
      function makeKnowledgeMarker(id, extraClasses="") {
        const container = document.createElement("div");
        container.className = "knowledge__container " + extraClasses
        container.id = id

        for(let i=0;i<GLOBAL_STATE.total_triples;i++) {
          const marker = document.createElement("div");
          marker.className = "knowledge__marker knowledge__marker--black"
          container.appendChild(marker)
        }

        return container
      }

      function knowledgeToDict(knowledge) {
        if(!knowledge) return {}
        let state = {}
        for(let k of knowledge) {
          if(k > 0 && !state[k]) state[k] = "green"
          if(k < 0) state[-k] = "red"
        }
        return state
      }

      function isDict(v) {
          return typeof v==='object' && v!==null && !(v instanceof Array) && !(v instanceof Date);
      }

      function updateKnowledgeMarker(marker, knowledge) {
        let state = knowledge
        if(!isDict(state)) state = knowledgeToDict(knowledge)
        let markers = marker.children
        for(let i=1;i<=GLOBAL_STATE["total_triples"]; i++) {
          markers[i-1].className = `knowledge__marker knowledge__marker--${state[i] || "black"}`
        }
      }

      function renderKnowledgeMarkers(knowledge, masters) {
        let root = document.getElementById("marker-root")
        for(let child of root.children) {
          if(!knowledge[child.id]) child.remove()
        }

        masters = new Set(masters)

        let i = 0
        for(let agent in knowledge) {
          if(!document.getElementById(agent)) 
            root.appendChild(makeKnowledgeMarker(agent, "knowledge__container--in-circle"))

            let marker = document.getElementById(agent)
            updateKnowledgeMarker(marker, knowledge[agent])
            marker.style.setProperty("--angle", i/Object.keys(knowledge).length)
            marker.classList.toggle("knowledge__container--master", masters.has(agent))
            i += 1
        }

        updateGlobalMarkers(knowledge)
      }

      function initGlobalMarkers() {
        let root = document.getElementById("global-markers")
        for(let child of root.children) child.remove()
        for(let key of ["Worst", "Best", "Total"]) {
          let div = document.createElement("div")
          div.appendChild(makeKnowledgeMarker(`global-marker-${key.toLowerCase()}`, 'knowledge__container--global'))
          div.classList = "global-marker__container"
          let span = document.createElement("span")
          span.innerText = key
          span.classList = "global-marker__label"
          div.appendChild(span)
          root.appendChild(div)
        }
      }

      function updateGlobalMarkers(knowledge) {
        let totalKnowledge = {}
        let worstScore = Infinity, worstAgent = null
        let bestScore = -Infinity, bestAgent = null

        for(let agent in knowledge) {
          let state = knowledgeToDict(knowledge[agent])
          let score = 0
          for(let key in state) {
            if(state[key] == "green") {
              totalKnowledge[key] = "green"
              score += 1
            }
            if(state[key] == "red") {
              if(!totalKnowledge[key]) totalKnowledge[key] = "red"
              score -= 1
            }
          }

          if(score < worstScore) {
            worstAgent = agent
            worstScore = score
          }
          if(score > bestScore) {
            bestAgent = agent
            bestScore = score
          }
        }

        updateKnowledgeMarker(document.getElementById("global-marker-worst"), knowledge[worstAgent])
        updateKnowledgeMarker(document.getElementById("global-marker-best"), knowledge[bestAgent])
        updateKnowledgeMarker(document.getElementById("global-marker-total"), totalKnowledge)
      }

      function updateKnowledgeMarkerWidth() {
        document.body.style.setProperty("--marker-width", Math.ceil(Math.sqrt(GLOBAL_STATE["total_triples"])))
        for(let marker of document.getElementsByClassName(".knowledge__container")) marker.remove()
        initGlobalMarkers()
      }


      // State and main loop
      const GLOBAL_STATE = {}
      function updateGlobalState(key, value, onChange) {
        let changed = GLOBAL_STATE[key] != value
        GLOBAL_STATE[key] = value
        if(changed) onChange()
        return changed
      }

      function renderState(state) {
        updateGlobalState("total_triples", state["total_triples"], updateKnowledgeMarkerWidth) // TODO
        renderKnowledgeMarkers(state["agent_knowledge"], state["merge_masters"])
        console.log(state)
      }
      setInterval(() => {
        endpointGet("get_state").then(renderState)
      }, 500)

      
    </script>  
  </body>
</html>